

## The algorithm

### Preprocessing the shape

 * Required properties array is created for every NodeShape
 * Properties map is created for every nodeshape

### Running itself

It first finds all triples with the entity URI as their subject. It then checks whether all required properties from the SHACL shape have been found. If not, it dereferences the entity, adds all found triples to the store, and again finds all triples with the entity URI as the subject. It adds these triples to the result.

For all blank node objects it found, it finds all triples with that blank node as their subject, and recursively (while avoiding circular references), does the same on the blank nodes in the objects of the found triples. It adds all triples to the result.

It then continues the algorithm by checking the SHACL shape for `sh:path`s. Two cases are identified:
 1. Where the `sh:path` refers to a leaf (no reference to a `sh:node`)
 2. Where the `sh:path` refers to a node with required properties of their own by using `sh:node`

In 1, if the property is required and cannot be found in the current store, it will dereference the penultimate namednode matched by the sequence path. In 2, if the 

In both cases, all triples used for the path matching are added to the result. In case 2, the full algorithm is ran again on that node with a subset of the shape, while avoiding circular references.

The algorithm visits each entity only once.
